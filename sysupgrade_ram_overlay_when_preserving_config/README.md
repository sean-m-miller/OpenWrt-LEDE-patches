**The Bug:** If a config is preserved across firmware upgrades via the sysupgrade utility (`sysupgrade -c`), the /tmp RAM overlay is skipped and the jffs2 overlay is prepared and mounted while the preinit_main script hangs. This is a bug and can lockup boards with large "rootfs_data" partitions. 

**Description:** In 2008, the [ability to preserve a config across sysupgrades](https://github.com/bmork/OpenWrt/blob/master/package/system/mtd/src/jffs2.c) was added (see mtd_replace_jffs2()). The mechanism, which is still the behavior in the offical OpenWrt repo today, writes the tar file to be preserved at the beginning of the rootfs_data partition, and moves the [0xdeadc0de flag that signifies the rootfs/rootfs_data boundary](https://openwrt.org/docs/techref/filesystems) to be at the start of the next erase block after the tar file. The file is written as a valid jffs2 node, which requires that it is preceded by a valid jffs2 file header. jffs2 file headers have 0x1985 as the first 2 bytes, and note that this is the same as the first 2 bytes of a jffs2 ["CLEANMARKER"](https://github.com/m-labs/openwrt-milkymist/blob/master/package/mtd/src/jffs2.c), which is defined as 0x198520030000000cf060dc98.

Then, on reboot, the [80_mount_root](https://github.com/openwrt/openwrt/blob/master/package/base-files/files/lib/preinit/80_mount_root) script calls the [mount_root](https://git.openwrt.org/?p=project/fstools.git;a=blob;f=mount_root.c) utility, which examines the first bytes of the rootfs_data partition using [this](https://lxr.openwrt.org/source/fstools/libfstools/mtd.c) logic. As you can see, it examines the first four bytes of the partition to try to match with 0xdeadc0de to set the FS_DEADCODE case, but instead matches with the 2 byte 0x1985 (due to the jffs2 file header format), setting the FS_JFFS2 case. Therefore, the mount_root utility gets "tricked" into thinking that the rootfs_data partition has been formatted, with every erase block being set to the jffs2 cleanmarker followed by 0xff until the next block boundary. This causes mount_root to immediately launch the jffs2 driver to mount the jffs2 overlay with the assumption that there is no more cleaning or formatting work to be done. [This behaviour is undesired](https://openwrt.org/docs/techref/preinit_mount) (consider steps 3-5 in the **Mount Root Filesystem**), since it hangs the preinit main while the jffs2 driver cleans and formats the rootfs_data partition. The desired behavior is to have mount_root fall into the FS_DEADCODE case, which mounts a /tmp RAM overlay, and defers the switch to the jffs2 overlay until the [/etc/init.d/done](https://github.com/openwrt/openwrt/blob/master/package/base-files/files/etc/init.d/done) script gets called at the end of the init sequence.


**The Patch:** 

**Reasons for not Submitting to official Repo:** 
